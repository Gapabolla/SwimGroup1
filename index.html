<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–±–ª–∏—Ü–∞ –≤ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ */
        :root {
            --primary-color: #0088cc;
            --border-color: #e0e0e0;
            --hover-bg: rgba(0, 136, 204, 0.05);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.4;
            font-size: 14px;
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .admin-btn {
            display: none;
            background: var(--primary-color);
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 16px;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .admin-btn:hover {
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }
        
        .refresh-btn {
            background: var(--tg-theme-button-color, var(--primary-color));
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #0077b3;
        }
        
        .refresh-btn:active {
            transform: scale(0.98);
        }
        
        .last-update {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #888888);
            text-align: right;
            flex: 1;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            margin-bottom: 20px;
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-weight: 600;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            font-size: 14px;
            white-space: nowrap;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border-color);
            background: var(--tg-theme-bg-color, #ffffff);
            word-break: break-word;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td {
            background: var(--hover-bg);
        }
        
        .loading {
            padding: 60px 20px;
            text-align: center;
            color: var(--tg-theme-hint-color, #888888);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 136, 204, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            padding: 40px 20px;
            text-align: center;
            color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .stats {
            text-align: center;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #888888);
            padding: 12px;
            border-top: 1px solid var(--border-color);
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
        }
        
        a {
            color: var(--primary-color);
            text-decoration: none;
            word-break: break-all;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 12px;
                font-size: 13px;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .refresh-btn, .last-update {
                width: 100%;
                text-align: center;
            }
        }
        
        .config-panel {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        .test-data-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a id="editBtn" href="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit" class="admin-btn">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
        </a>
        
        <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º) -->
        <div id="configPanel" class="config-panel" style="display: none;">
            <h3 style="margin-top: 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <input type="text" id="sheetIdInput" class="config-input" placeholder="Google Sheets ID">
            <input type="text" id="apiKeyInput" class="config-input" placeholder="Google API Key">
            <input type="text" id="sheetNameInput" class="config-input" placeholder="–ò–º—è –ª–∏—Å—Ç–∞ (Sheet1)">
            <button onclick="saveConfig()" class="refresh-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button onclick="testWithSampleData()" class="test-data-btn">üß™ –¢–µ—Å—Ç —Å –ø—Ä–∏–º–µ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö</button>
            <button onclick="testConnection()" class="refresh-btn">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        </div>
        
        <div class="controls">
            <button onclick="loadTableData()" class="refresh-btn" id="refreshBtn">
                <span id="refreshText">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</span>
            </button>
            <div class="last-update" id="lastUpdate">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
    </div>
    
    <div class="table-container" id="tableContainer">
        <div class="loading" id="loading">
            <span class="loading-spinner"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>
    
    <div class="stats" id="stats"></div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        let CONFIG = {
            SHEET_ID: localStorage.getItem('https://docs.google.com/spreadsheets/d/1013rhkCZ-xFHPzWgrB-RICCkJkXYhOq-wZPBUZUzTV8/edit?usp=sharing') || '',
            API_KEY: localStorage.getItem('AIzaSyDd9JykitTR1w7mtbN5iT6vvyOL18VxjSM') || '',
            SHEET_NAME: localStorage.getItem('sheet_name') || 'Sheet1',
            ADMIN_ID: 517194795, // –í–∞—à Telegram ID
            USE_CORS_PROXY: true, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CORS –ø—Ä–æ–∫—Å–∏
            AUTO_REFRESH: 60
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        let isLoading = false;
        let lastLoaded = null;
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function saveConfig() {
            CONFIG.SHEET_ID = document.getElementById('sheetIdInput').value.trim();
            CONFIG.API_KEY = document.getElementById('apiKeyInput').value.trim();
            CONFIG.SHEET_NAME = document.getElementById('sheetNameInput').value.trim() || 'Sheet1';
            
            localStorage.setItem('sheet_id', CONFIG.SHEET_ID);
            localStorage.setItem('api_key', CONFIG.API_KEY);
            localStorage.setItem('sheet_name', CONFIG.SHEET_NAME);
            
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            loadTableData();
        }
        
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        function testWithSampleData() {
            const sampleData = {
                values: [
                    ['–ò–º—è', '–í–æ–∑—Ä–∞—Å—Ç', '–ì–æ—Ä–æ–¥', '–¢–µ–ª–µ—Ñ–æ–Ω'],
                    ['–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞', '25', '–ú–æ—Å–∫–≤–∞', '+7 999 123-45-67'],
                    ['–ò–≤–∞–Ω –°–∏–¥–æ—Ä–æ–≤', '30', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '+7 999 765-43-21'],
                    ['–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞', '28', '–ö–∞–∑–∞–Ω—å', '+7 999 888-77-66'],
                    ['–ê–ª–µ–∫—Å–µ–π –ö—É–∑–Ω–µ—Ü–æ–≤', '35', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '+7 999 555-44-33'],
                    ['–ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞', '22', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '+7 999 222-11-00']
                ]
            };
            
            renderTable(sampleData.values);
            updateLastUpdateTime();
            document.getElementById('stats').textContent = 
                `–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: ${sampleData.values.length - 1} —Å—Ç—Ä–æ–∫, ${sampleData.values[0].length} –∫–æ–ª–æ–Ω–æ–∫`;
            setLoading(false);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function testConnection() {
            if (!CONFIG.SHEET_ID || !CONFIG.API_KEY) {
                alert('–í–≤–µ–¥–∏—Ç–µ SHEET_ID –∏ API_KEY');
                return;
            }
            
            setLoading(true);
            const testUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?key=${CONFIG.API_KEY}&fields=properties.title`;
            
            try {
                const response = await fetchWithRetry(testUrl);
                const data = await response.json();
                alert(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: ${data.properties.title}`);
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\n${error.message}`);
            } finally {
                setLoading(false);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è fetch —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ CORS –ø—Ä–æ–∫—Å–∏
        async function fetchWithRetry(url, retries = 3) {
            const proxies = [
                '', // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å
                'https://corsproxy.io/?', 
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://thingproxy.freeboard.io/fetch/'
            ];
            
            for (let attempt = 0; attempt < retries; attempt++) {
                for (const proxy of proxies) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(url);
                        console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1}, –ø—Ä–æ–∫—Å–∏: ${proxy || '–Ω–µ—Ç'}`);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            console.log('–£—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑:', proxy || '–ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                            return response;
                        }
                    } catch (error) {
                        console.warn(`–û—à–∏–±–∫–∞ —Å –ø—Ä–æ–∫—Å–∏ ${proxy}:`, error.message);
                    }
                }
                
                if (attempt < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                }
            }
            
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫');
        }
        
        // –ú–µ—Ç–æ–¥ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSON feed (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á–∞)
        async function loadViaJSONFeed() {
            const jsonUrl = `https://spreadsheets.google.com/feeds/list/${CONFIG.SHEET_ID}/od6/public/values?alt=json`;
            
            try {
                const response = await fetchWithRetry(jsonUrl);
                const data = await response.json();
                
                if (!data.feed || !data.feed.entry) {
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö');
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –≤ –º–∞—Å—Å–∏–≤
                const rows = [];
                
                // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const firstEntry = data.feed.entry[0];
                const headers = [];
                
                for (let key in firstEntry) {
                    if (key.startsWith('gsx$')) {
                        const headerName = key.replace('gsx$', '').replace(/-/g, ' ');
                        headers.push(headerName);
                    }
                }
                
                rows.push(headers);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                data.feed.entry.forEach(entry => {
                    const row = [];
                    for (let key in entry) {
                        if (key.startsWith('gsx$')) {
                            row.push(entry[key].$t || '');
                        }
                    }
                    rows.push(row);
                });
                
                return rows;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ JSON feed:', error);
                throw error;
            }
        }
        
        // –ú–µ—Ç–æ–¥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CSV —ç–∫—Å–ø–æ—Ä—Ç–∞
        async function loadViaCSV() {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv`;
            
            try {
                const response = await fetchWithRetry(csvUrl);
                const csvText = await response.text();
                
                // –ü–∞—Ä—Å–∏–º CSV
                const rows = [];
                const lines = csvText.split('\n');
                
                lines.forEach(line => {
                    if (line.trim()) {
                        // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ CSV (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –Ω—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
                        const cells = line.split(',').map(cell => {
                            return cell.replace(/^"(.*)"$/, '$1').trim();
                        });
                        rows.push(cells);
                    }
                });
                
                return rows;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ CSV:', error);
                throw error;
            }
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        async function loadTableData() {
            if (isLoading) return;
            setLoading(true);
            
            try {
                let rows;
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                if (CONFIG.API_KEY && CONFIG.SHEET_ID) {
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ Google Sheets API...');
                    const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEET_NAME}?key=${CONFIG.API_KEY}`;
                    const response = await fetchWithRetry(apiUrl);
                    const data = await response.json();
                    rows = data.values;
                } else if (CONFIG.SHEET_ID) {
                    console.log('–ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ JSON feed...');
                    rows = await loadViaJSONFeed();
                } else {
                    throw new Error('–ù–µ —É–∫–∞–∑–∞–Ω SHEET_ID');
                }
                
                if (!rows || rows.length === 0) {
                    throw new Error('–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞');
                }
                
                renderTable(rows);
                updateLastUpdateTime();
                document.getElementById('stats').textContent = 
                    `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${rows.length - 1} —Å—Ç—Ä–æ–∫, ${rows[0].length} –∫–æ–ª–æ–Ω–æ–∫`;
                
            } catch (error) {
                console.error('–í—Å–µ –º–µ—Ç–æ–¥—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É
                document.getElementById('tableContainer').innerHTML = `
                    <div class="error">
                        <div style="font-size: 32px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div style="font-weight: bold; margin-bottom: 8px; font-size: 16px;">
                            –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
                        </div>
                        <div style="margin-bottom: 16px; font-size: 14px; font-family: monospace;">
                            ${error.message}
                        </div>
                        <div style="font-size: 12px; opacity: 0.7; text-align: left;">
                            <strong>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</strong><br>
                            1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞:<br>
                               - –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É<br>
                               - –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" ‚Üí "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞"<br>
                               - –í—ã–±–µ—Ä–∏—Ç–µ "–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º, —É –∫–æ–≥–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞"<br><br>
                            
                            2. –ü–æ–ª—É—á–∏—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –∏–∑ URL:<br>
                               https://docs.google.com/spreadsheets/d/<strong>–≠–¢–û_–í–ê–®_ID</strong>/edit<br><br>
                            
                            3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á:<br>
                               - –ó–∞–π–¥–∏—Ç–µ –Ω–∞ <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a><br>
                               - –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç ‚Üí –í–∫–ª—é—á–∏—Ç–µ Google Sheets API<br>
                               - –°–æ–∑–¥–∞–π—Ç–µ API –∫–ª—é—á –≤ "Credentials"<br>
                        </div>
                    </div>
                `;
                
                document.getElementById('stats').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                
            } finally {
                setLoading(false);
            }
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (renderTable, escapeHtml, formatTime, updateLastUpdateTime, setLoading)
        // –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ
        
        function formatTime(date) {
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            lastLoaded = now;
            document.getElementById('lastUpdate').textContent = 
                `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatTime(now)}`;
        }
        
        function setLoading(state) {
            isLoading = state;
            const btn = document.getElementById('refreshBtn');
            const text = document.getElementById('refreshText');
            
            if (state) {
                btn.disabled = true;
                text.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
                document.getElementById('loading').style.display = 'block';
            } else {
                btn.disabled = false;
                text.innerHTML = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å';
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function renderTable(rows) {
            const container = document.getElementById('tableContainer');
            
            if (!rows || rows.length < 2) {
                container.innerHTML = '<div class="error">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }
            
            let html = '<table>';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            html += '<thead><tr>';
            rows[0].forEach((header, index) => {
                const cleanHeader = header.trim() || `–ö–æ–ª–æ–Ω–∫–∞ ${index + 1}`;
                html += `<th>${escapeHtml(cleanHeader)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // –î–∞–Ω–Ω—ã–µ
            for (let i = 1; i < rows.length; i++) {
                html += '<tr>';
                rows[i].forEach((cell, cellIndex) => {
                    let cellContent = escapeHtml(cell || '');
                    
                    if (cellContent.startsWith('http://') || cellContent.startsWith('https://')) {
                        cellContent = `<a href="${cell}" target="_blank">${cellContent}</a>`;
                    }
                    
                    if (cellContent.includes('@') && cellContent.includes('.') && !cellContent.includes(' ')) {
                        cellContent = `<a href="mailto:${cell}">${cellContent}</a>`;
                    }
                    
                    html += `<td>${cellContent}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
            if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.id == CONFIG.ADMIN_ID) {
                document.getElementById('editBtn').style.display = 'block';
                document.getElementById('configPanel').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∏–∑ localStorage
                document.getElementById('sheetIdInput').value = CONFIG.SHEET_ID;
                document.getElementById('apiKeyInput').value = CONFIG.API_KEY;
                document.getElementById('sheetNameInput').value = CONFIG.SHEET_NAME;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (CONFIG.SHEET_ID) {
                loadTableData();
            } else {
                testWithSampleData(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä
            }
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            if (CONFIG.AUTO_REFRESH > 0) {
                setInterval(() => {
                    if (!isLoading && document.visibilityState === 'visible' && CONFIG.SHEET_ID) {
                        loadTableData();
                    }
                }, CONFIG.AUTO_REFRESH * 1000);
            }
        });
    </script>
</body>
</html>
